<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Iterative Solvers Â· ClimateMachine</title><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../../../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../../../assets/documenter.js"></script><script src="../../../../siteinfo.js"></script><script src="../../../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../../../"><img src="../../../../assets/logo.svg" alt="ClimateMachine logo"/></a><div class="docs-package-name"><span class="docs-autofit">ClimateMachine</span></div><form class="docs-search" action="../../../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../../../">Home</a></li><li><input class="collapse-toggle" id="menuitem-2" type="checkbox"/><label class="tocitem" for="menuitem-2"><span class="docs-label">Getting started</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../GettingStarted/Installation/">Installation</a></li><li><a class="tocitem" href="../../../../GettingStarted/Terminology/">Terminology</a></li><li><a class="tocitem" href="../../../../GettingStarted/RunningClimateMachine/">Running</a></li><li><input class="collapse-toggle" id="menuitem-2-4" type="checkbox"/><label class="tocitem" for="menuitem-2-4"><span class="docs-label">Defaults</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../GettingStarted/Atmos/">Atmosphere model configurations</a></li></ul></li></ul></li><li><span class="tocitem">Tutorials</span></li><li><input class="collapse-toggle" id="menuitem-4" type="checkbox" checked/><label class="tocitem" for="menuitem-4"><span class="docs-label">How-to-guides</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-4-1" type="checkbox"/><label class="tocitem" for="menuitem-4-1"><span class="docs-label">Common</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../Common/Thermodynamics/">Thermodynamics</a></li><li><a class="tocitem" href="../../../Common/UniversalFunctions/">Universal Functions</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-2" type="checkbox"/><label class="tocitem" for="menuitem-4-2"><span class="docs-label">Atmos</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../Atmos/TemperatureProfiles/">Temperature profiles</a></li><li><a class="tocitem" href="../../../Atmos/AtmosReferenceState/">Reference profiles</a></li><li><a class="tocitem" href="../../../Atmos/MoistureModelChoices/">Moisture model</a></li><li><a class="tocitem" href="../../../Atmos/PrecipitationModelChoices/">Precipitation model</a></li></ul></li><li><span class="tocitem">Ocean</span></li><li><span class="tocitem">Land</span></li><li><input class="collapse-toggle" id="menuitem-4-5" type="checkbox" checked/><label class="tocitem" for="menuitem-4-5"><span class="docs-label">Numerics</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><span class="tocitem">Meshes</span></li><li><input class="collapse-toggle" id="menuitem-4-5-2" type="checkbox"/><label class="tocitem" for="menuitem-4-5-2"><span class="docs-label">DG methods</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../DGMethods/how_to_make_a_balance_law/">How to make a balance law</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-5-3" type="checkbox"/><label class="tocitem" for="menuitem-4-5-3"><span class="docs-label">ODE Solvers</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../ODESolvers/Timestepping/">Time-integration</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-5-4" type="checkbox" checked/><label class="tocitem" for="menuitem-4-5-4"><span class="docs-label">System Solvers</span><i class="docs-chevron"></i></label><ul class="collapsed"><li class="is-active"><a class="tocitem" href>Iterative Solvers</a><ul class="internal"><li><a class="tocitem" href="#Basic-Template-for-an-Iterative-Solver"><span>Basic Template for an Iterative Solver</span></a></li><li><a class="tocitem" href="#ClimateMachine-Specific-Considerations"><span>ClimateMachine Specific Considerations</span></a></li><li><a class="tocitem" href="#Preconditioners"><span>Preconditioners</span></a></li><li><a class="tocitem" href="#Writing-Tests"><span>Writing Tests</span></a></li><li><a class="tocitem" href="#Performance-Checks"><span>Performance Checks</span></a></li><li><a class="tocitem" href="#Conventions"><span>Conventions</span></a></li></ul></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-6" type="checkbox"/><label class="tocitem" for="menuitem-4-6"><span class="docs-label">Diagnostics</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../Diagnostics/UsingDiagnostics/">Using Diagnostics</a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-5" type="checkbox"/><label class="tocitem" for="menuitem-5"><span class="docs-label">APIs</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../APIs/">Home</a></li><li><input class="collapse-toggle" id="menuitem-5-2" type="checkbox"/><label class="tocitem" for="menuitem-5-2"><span class="docs-label">Driver</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../APIs/Driver/">Top level interface</a></li><li><a class="tocitem" href="../../../../APIs/Driver/Checkpoint/">Checkpoint</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5-3" type="checkbox"/><label class="tocitem" for="menuitem-5-3"><span class="docs-label">Atmos</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../APIs/Atmos/AtmosModel/">AtmosModel</a></li><li><a class="tocitem" href="../../../../APIs/Atmos/Microphysics_0M/">Microphysics_0M</a></li><li><a class="tocitem" href="../../../../APIs/Atmos/Microphysics/">Microphysics</a></li><li><a class="tocitem" href="../../../../APIs/Atmos/TemperatureProfiles/">Temperature Profiles</a></li></ul></li><li><a class="tocitem" href="../../../../APIs/Ocean/Ocean/">Ocean</a></li><li><input class="collapse-toggle" id="menuitem-5-5" type="checkbox"/><label class="tocitem" for="menuitem-5-5"><span class="docs-label">Land</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../APIs/Land/LandModel/">Land Model</a></li><li><a class="tocitem" href="../../../../APIs/Land/Runoff/">Runoff Parameterizations</a></li><li><a class="tocitem" href="../../../../APIs/Land/SoilWaterParameterizations/">Soil Water Parameterizations</a></li><li><a class="tocitem" href="../../../../APIs/Land/SoilHeatParameterizations/">Soil Heat Parameterizations</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5-6" type="checkbox"/><label class="tocitem" for="menuitem-5-6"><span class="docs-label">Common</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../APIs/Common/Orientations/">Orientations</a></li><li><a class="tocitem" href="../../../../APIs/Common/Spectra/">Spectra</a></li><li><a class="tocitem" href="../../../../APIs/Common/SurfaceFluxes/">Surface Fluxes</a></li><li><a class="tocitem" href="../../../../APIs/Common/Thermodynamics/">Thermodynamics</a></li><li><a class="tocitem" href="../../../../APIs/Common/TurbulenceClosures/">Turbulence Closures</a></li><li><a class="tocitem" href="../../../../APIs/Common/TurbulenceConvection/">Turbulence Convection</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5-7" type="checkbox"/><label class="tocitem" for="menuitem-5-7"><span class="docs-label">Balance Laws</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../APIs/BalanceLaws/BalanceLaws/">Balance Laws</a></li><li><a class="tocitem" href="../../../../APIs/BalanceLaws/Problems/">Problems</a></li></ul></li><li><a class="tocitem" href="../../../../APIs/Arrays/Arrays/">Arrays</a></li><li><input class="collapse-toggle" id="menuitem-5-9" type="checkbox"/><label class="tocitem" for="menuitem-5-9"><span class="docs-label">Diagnostics</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../APIs/Diagnostics/Diagnostics/">Diagnostics groups</a></li><li><a class="tocitem" href="../../../../APIs/Diagnostics/StateCheck/">State Check</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5-10" type="checkbox"/><label class="tocitem" for="menuitem-5-10"><span class="docs-label">Input/Output</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../APIs/InputOutput/">Input/Output</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5-11" type="checkbox"/><label class="tocitem" for="menuitem-5-11"><span class="docs-label">Numerics</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../APIs/Numerics/Meshes/Mesh/">Meshes</a></li><li><a class="tocitem" href="../../../../APIs/Numerics/SystemSolvers/SystemSolvers/">SystemSolvers</a></li><li><a class="tocitem" href="../../../../APIs/Numerics/ODESolvers/ODESolvers/">ODESolvers</a></li><li><a class="tocitem" href="../../../../APIs/Numerics/DGMethods/DGMethods/">DG Methods</a></li><li><a class="tocitem" href="../../../../APIs/Numerics/DGMethods/Courant/">Courant</a></li><li><a class="tocitem" href="../../../../APIs/Numerics/DGMethods/NumericalFluxes/">Numerical Fluxes</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5-12" type="checkbox"/><label class="tocitem" for="menuitem-5-12"><span class="docs-label">Utilities</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../APIs/Utilities/VariableTemplates/">Variable Templates</a></li><li><a class="tocitem" href="../../../../APIs/Utilities/SingleStackUtils/">Single Stack Utilities</a></li><li><a class="tocitem" href="../../../../APIs/Utilities/TicToc/">Tic Toc</a></li></ul></li></ul></li><li><a class="tocitem" href="../../../../Contributing/">Contribution guide</a></li><li><input class="collapse-toggle" id="menuitem-7" type="checkbox"/><label class="tocitem" for="menuitem-7"><span class="docs-label">Theory</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-7-1" type="checkbox"/><label class="tocitem" for="menuitem-7-1"><span class="docs-label">Common</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../Theory/Common/SurfaceFluxes/">SurfaceFluxes</a></li><li><a class="tocitem" href="../../../../Theory/Common/Turbulence/">Turbulence Closures</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-7-2" type="checkbox"/><label class="tocitem" for="menuitem-7-2"><span class="docs-label">Atmos</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../Theory/Atmos/AtmosModel/">AtmosModel</a></li><li><a class="tocitem" href="../../../../Theory/Atmos/Microphysics_0M/">Microphysics_0M</a></li><li><a class="tocitem" href="../../../../Theory/Atmos/Microphysics/">Microphysics</a></li><li><a class="tocitem" href="../../../../Theory/Atmos/EDMFEquations/">EDMF equations</a></li><li><a class="tocitem" href="../../../../Theory/Atmos/Model/tracers/">Tracers</a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-8" type="checkbox"/><label class="tocitem" for="menuitem-8"><span class="docs-label">Developer docs</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../DevDocs/CodeStyle/">Coding style</a></li><li><a class="tocitem" href="../../../../DevDocs/AcceptableUnicode/">Acceptable Unicode</a></li><li><a class="tocitem" href="../../../../DevDocs/ModelVariableList/">Model variable list</a></li><li><a class="tocitem" href="../../../../DevDocs/ModelOutput/">Model output</a></li><li><a class="tocitem" href="../../../../DevDocs/DiagnosticVariableList/">Diagnostic variable list</a></li><li><a class="tocitem" href="../../../../DevDocs/SystemImage/">Custom System Image</a></li></ul></li><li><a class="tocitem" href="../../../../References/">References</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">How-to-guides</a></li><li><a class="is-disabled">Numerics</a></li><li><a class="is-disabled">System Solvers</a></li><li class="is-active"><a href>Iterative Solvers</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Iterative Solvers</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/CliMA/ClimateMachine.jl/blob/master/docs/src/HowToGuides/Numerics/SystemSolvers/IterativeSolvers.md" title="Edit on GitHub"><span class="docs-icon fab">ï</span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Contribution-Guide-for-Abstract-Iterative-Solvers"><a class="docs-heading-anchor" href="#Contribution-Guide-for-Abstract-Iterative-Solvers">Contribution Guide for Abstract Iterative Solvers</a><a id="Contribution-Guide-for-Abstract-Iterative-Solvers-1"></a><a class="docs-heading-anchor-permalink" href="#Contribution-Guide-for-Abstract-Iterative-Solvers" title="Permalink"></a></h1><p>An abstract iterative solver requires <strong>one struct</strong>, <strong>one constructor</strong>, and <strong>two functions</strong> in order to interface with the rest of <a href="https://github.com/CliMA/ClimateMachine.jl">ClimateMachine</a>. In what follows we will describe in detail the function signatures, return values, and struct properties necessary to build with <a href="https://github.com/CliMA/ClimateMachine.jl">ClimateMachine</a>.</p><p>We have the following concrete implementations:</p><ol><li><a href="../../../../APIs/Numerics/SystemSolvers/SystemSolvers/#ClimateMachine.SystemSolvers.GeneralizedMinimalResidual"><code>GeneralizedMinimalResidual</code></a></li><li><a href="../../../../APIs/Numerics/SystemSolvers/SystemSolvers/#ClimateMachine.SystemSolvers.GeneralizedConjugateResidual"><code>GeneralizedConjugateResidual</code></a></li><li><a href="../../../../APIs/Numerics/SystemSolvers/SystemSolvers/#ClimateMachine.SystemSolvers.ConjugateGradient"><code>ConjugateGradient</code></a></li><li><a href="../../../../APIs/Numerics/SystemSolvers/SystemSolvers/#ClimateMachine.SystemSolvers.BatchedGeneralizedMinimalResidual"><code>BatchedGeneralizedMinimalResidual</code></a></li></ol><h2 id="Basic-Template-for-an-Iterative-Solver"><a class="docs-heading-anchor" href="#Basic-Template-for-an-Iterative-Solver">Basic Template for an Iterative Solver</a><a id="Basic-Template-for-an-Iterative-Solver-1"></a><a class="docs-heading-anchor-permalink" href="#Basic-Template-for-an-Iterative-Solver" title="Permalink"></a></h2><p>A basic template of an iterative solver could be as follows:</p><pre><code class="language-julia">
export MyIterativeMethod

# struct
struct MyIterativeMethod{FT} &lt;: AbstractIterativeSystemSolver
    # minimum
    rtol::FT
    atol::FT
    # Add more structure if necessary
end

# constructor
function MyIterativeMethod(args...)
    # body of constructor
    return MyIterativeMethod(contructor_args...)
end

# initialize function (1)
function initialize!(linearoperator!, Q, Qrhs, solver::MyIterativeMethod, args...)
    # body of initialize function in abstract iterative solver
    return Bool, Int
end

# iteration function (2)
function doiteration!(linearoperator!, Q, Qrhs, solver::MyIterativeMethod, threshold, args...)
    # body of iteration
    return Bool, Int, Float
end
</code></pre><p>MyIterativeMethod and function bodies would need to be replaced appropriately for a particular implementation. We will describe each component in detail in subsequent sections.</p><h3 id="Struct"><a class="docs-heading-anchor" href="#Struct">Struct</a><a id="Struct-1"></a><a class="docs-heading-anchor-permalink" href="#Struct" title="Permalink"></a></h3><p>A subset of AbstractIterativeSystemSolver needs at least two members: atol and rtol. The former represents an absolute tolerance and the latter is a relative tolerance. Both can be used to terminate the iteration to determine the convergence criteria. An example struct could be</p><pre><code class="language-julia">struct MyIterativeMethod{FT} &lt;: AbstractIterativeSystemSolver
    atol::FT
    rtol::FT
end</code></pre><p>but often has more depending on the kind of iterative solver being used.  For example, in a Krylov subspace method one would need to store a number of vectors which constitute the <a href="https://en.wikipedia.org/wiki/Krylov_subspace">Krylov subspace</a>.</p><h3 id="Constructor"><a class="docs-heading-anchor" href="#Constructor">Constructor</a><a id="Constructor-1"></a><a class="docs-heading-anchor-permalink" href="#Constructor" title="Permalink"></a></h3><p>The constructor for the struct can be defined any number of ways depending on the needs of the struct itself. Often times this is just used to allocate memory or convergence thresholds. This can also be a good place to define structures that make the iterative solver easier to work with. For example, for a columnwise solver one would want an easy array structure to work with vectors in a columnwise fashion.</p><p>In <a href="#Basic-Template-for-an-Iterative-Solver">Basic Template for an Iterative Solver</a> we used an outer constructor, e.g.,</p><pre><code class="language-julia"># constructor
function MyIterativeMethod(args...)
    # body of constructor
    return MyIterativeMethod(contructor_args...)
end</code></pre><p>but we could have also used an inner constructor if desired.</p><h3 id="Initialize-Function"><a class="docs-heading-anchor" href="#Initialize-Function">Initialize Function</a><a id="Initialize-Function-1"></a><a class="docs-heading-anchor-permalink" href="#Initialize-Function" title="Permalink"></a></h3><p>The initialize function needs the following signature</p><pre><code class="language-julia">function initialize!(linearoperator!, Q, Qrhs, solver::MyIterativeMethod, args...)
    # body of initialize function in abstract iterative solver
    return Bool, Int
end</code></pre><p>The intialize function has the following <strong>arguments</strong>:</p><ol><li><code>linearoperator!</code> (function)</li><li><code>Q</code>    (array) [OVERWRITTEN]</li><li><code>Qrhs</code> (array)</li><li><code>solver</code> (struct) used for dispatch</li><li><code>args...</code> passed to <code>linearoperator!</code> function</li></ol><p>The <code>linearoperator!</code> function is assumed to have the following signature:</p><pre><code class="language-julia">linearoperator!(y, x, args...)
    # body of linear operator
    return nothing
end</code></pre><p>It represents action of a linear operator <span>$L$</span> on a vector <span>$x$</span>, that stores the value in the vector <span>$y$</span>, i.e. <span>$Lx = y$</span>. The last argument (the args...) is necessary due to how linear operators are defined within ClimateMachine.</p><p>The <code>Q</code> and <code>Qrhs</code> function arguments are supposed to represent the solution of the linear system <code>LQ = Qrhs</code> where <code>L</code> is the linear operator implicitly defined by <code>linearoperator!</code>.</p><p>The initialize function must have <strong>2 return values</strong>:</p><ol><li><code>convergence</code> (bool)</li><li><code>iterations</code> (int)</li></ol><p>The return values keep track of whether or not the iterative algorithm has converged as well as how many times the linear operator was applied.</p><h3 id="Iteration-Function"><a class="docs-heading-anchor" href="#Iteration-Function">Iteration Function</a><a id="Iteration-Function-1"></a><a class="docs-heading-anchor-permalink" href="#Iteration-Function" title="Permalink"></a></h3><p>The iteration function needs the following signature</p><pre><code class="language-julia">function doiteration!(linearoperator!, Q, Qrhs, solver::MyIterativeMethod, threshold, args...)
    # body of iteration
    return Bool, Int, Float
end</code></pre><p>The iteration function has the following <strong>arguments</strong>:</p><ol><li><code>linearoperator!</code> (function)</li><li><code>Q</code> (array) [OVERWRITTEN]</li><li><code>Qrhs</code> (array)</li><li><code>solver</code> (struct). used for dispatch</li><li><code>threshold</code> (float). for the convergence criteria</li><li><code>args...</code> passed into the <code>linearoperator!</code> function</li></ol><p>The <code>linearoperator!</code> function is assumed to have the following signature:</p><pre><code class="language-julia">linearoperator!(y, x, args...)
    # body of linear operator
    return nothing
end</code></pre><p>It represents action of a linear operator <span>$L$</span> on a vector <span>$x$</span>, that stores the value in the vector <span>$y$</span>, i.e. <span>$Lx = y$</span>. The last argument (the args...) is necessary due to how linear operators are defined within ClimateMachine.</p><p>The <code>Q</code> and <code>Qrhs</code> function arguments are supposed to represent the solution of the linear system <code>LQ = Qrhs</code> where <code>L</code> is the linear operator implicitly defined by <code>linearoperator!</code>.</p><p>The iteration function must have <strong>3 return values</strong>:</p><ol><li><code>converged</code> (bool)</li><li><code>iterations</code> (int)</li><li><code>residual_norm</code> (float64)</li></ol><p>The return values keep track of whether or not the iterative algorithm has converged as well as how many times the linear operator was applied. The residual norm is useful since it is often used to determine a stopping criteria.</p><h2 id="ClimateMachine-Specific-Considerations"><a class="docs-heading-anchor" href="#ClimateMachine-Specific-Considerations">ClimateMachine Specific Considerations</a><a id="ClimateMachine-Specific-Considerations-1"></a><a class="docs-heading-anchor-permalink" href="#ClimateMachine-Specific-Considerations" title="Permalink"></a></h2><p>An MPIStateArray <code>Q</code> in 3D, has the following structure by default:</p><pre><code class="language-julia">size(Q) = (n_ijk, n_s, n_e)</code></pre><p>where</p><ol><li><code>n_ijk</code> is the number of Gauss-Lobatto points per element</li><li><code>n_s</code> is the number of states</li><li><code>n_e</code> is the number of elements</li></ol><p>In three dimensions, if one wants to operate in a column-wise fashion (with a stacked-brick topology) it is easiest to reshape the array into the following form</p><pre><code class="language-julia">alias_Q = reshape(Q, (n_i, n_j, n_k, n_s, n_ev, n_eh))</code></pre><p>where</p><ol><li><code>n_i</code> is the number of Gauss-Lobatto points per element within</li></ol><p>element that are aligned with one of the horizontal directions.</p><ol><li><code>n_j</code> is the number of Gauss-Lobatto points per element within</li></ol><p>element that are aligned with another one of the horizontal directions.</p><ol><li><code>n_k</code> is the number of Gauss-Lobatto points within element that</li></ol><p>are aligned with the vertical direction.</p><ol><li><code>n_s</code> is the number of states</li><li><code>n_ev</code> is the number of elements in the vertical direction</li><li><code>n_eh</code> is the number of elements in the horizontal direction</li></ol><p>Note: <code>n_i x n_j x n_k = n_ijk</code> and <code>n_ev x n_eh = n_e</code>.</p><p>Thus if one wants to operate on a column for a fixed state index (let&#39;s say the int <code>s</code>) and a fixed horizontal coordinate (let&#39;s say fixed ints <code>i</code>, <code>j</code>, <code>eh</code>), then one could operator on the state:</p><pre><code class="language-julia">one_column = alias_Q[i, j, :, s, :, eh]</code></pre><p>which are the third and fifth argument in the MPIStateArray.</p><p>Some extra tips are:</p><ul><li>Since GPUs have limited memory, don&#39;t take up too much memory.</li><li>If possible define a preconditioner. Iterative methods are typically</li></ul><p>very slow otherwise.</p><h2 id="Preconditioners"><a class="docs-heading-anchor" href="#Preconditioners">Preconditioners</a><a id="Preconditioners-1"></a><a class="docs-heading-anchor-permalink" href="#Preconditioners" title="Permalink"></a></h2><p>The code needs to be slightly restructured to allow for preconditioners.</p><h2 id="Writing-Tests"><a class="docs-heading-anchor" href="#Writing-Tests">Writing Tests</a><a id="Writing-Tests-1"></a><a class="docs-heading-anchor-permalink" href="#Writing-Tests" title="Permalink"></a></h2><p>Test on small systems where answers can be checked analytically. Check with matrices with easily computable inverses, i.e., the identity matrix or a diagonal matrix. Test with diverse matrix structures. Test with different array types: Arrays, CuArrays, MPIStateArrays, etc. Also test with balance laws to make sure that it can actually be run with IMEX solvers on the CPU/GPU and their distributed analogues.</p><h2 id="Performance-Checks"><a class="docs-heading-anchor" href="#Performance-Checks">Performance Checks</a><a id="Performance-Checks-1"></a><a class="docs-heading-anchor-permalink" href="#Performance-Checks" title="Permalink"></a></h2><p>Timing performance can be done with general CPU/GPU guidelines</p><h2 id="Conventions"><a class="docs-heading-anchor" href="#Conventions">Conventions</a><a id="Conventions-1"></a><a class="docs-heading-anchor-permalink" href="#Conventions" title="Permalink"></a></h2><ul><li>Q refers to the initial guess for the iterative solver that gets</li></ul><p>overwritten with the final solution</p><ul><li>Qrhs refers to the right hand side of the linear system</li></ul></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../../ODESolvers/Timestepping/">Â« Time-integration</a><a class="docs-footer-nextpage" href="../../../Diagnostics/UsingDiagnostics/">Using Diagnostics Â»</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> on <span class="colophon-date" title="Friday 4 December 2020 00:55">Friday 4 December 2020</span>. Using Julia version 1.5.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
